<!DOCTYPE html>
<html>

<head>
	<title>e-xterm</title>

	<link rel="stylesheet" href="../css/index.css">

	<!-- Bootstrap -->
	<link rel="stylesheet" href="../third-party/bootstrap-5.0.0-beta1-dist/css/bootstrap.css">
	<script src="../third-party/bootstrap-5.0.0-beta1-dist/js/bootstrap.min.js"></script>

	<!-- Chrome tabs -->
	<script src="../third-party/draggabilly/dist/draggabilly.pkgd.js"></script>
	<script src="../third-party/chrome-tabs/js/chrome-tabs.js"></script>
	<link rel="stylesheet" href="../third-party/chrome-tabs/css/chrome-tabs.css">

	<!-- xterm.js -->
	<script src="../node_modules/xterm/lib/xterm.js"></script>
	<link rel="stylesheet" href="../node_modules/xterm/css/xterm.css">

</head>

<body>


	<!--
	<div id="first" style="width: 50%; height: 100%; padding: 5px;">
-->
	<!-- This is example styling for the badges -->
	<!--

		<div class="accordion" id="accordionExample2">
			<div class="accordion-item">
				<h2 class="accordion-header" id="headingOne">
					<button class="accordion-button" type="button" data-bs-toggle="collapse"
						data-bs-target="#collapseTwo" aria-expanded="true" aria-controls="collapseTwo">
						All Sessions
					</button>
				</h2>
				<div id="collapseTwo" class="accordion-collapse collapse show" aria-labelledby="headingOne"
					data-bs-parent="#accordionExample2">
					<div class="accordion-body">


						<div class="list-group" id="list-tab" role="tablist">
							<a class="list-group-item list-group-item-action active d-flex justify-content-between align-items-center"
								id="list-home-list" data-toggle="list" href="#list-home" role="tab"
								aria-controls="home">
								root@10.0.0.9
								<span class="badge rounded-pill"
									style="background-color:black; color: white;">SSH</span>
							</a>
							<a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
								id="list-profile-list" data-toggle="list" href="#list-profile" role="tab"
								aria-controls="profile">
								shlomid R80.40 GW 172.23.13.204
								<span class="badge rounded-pill"
									style="background-color: chartreuse; color: black;">FTP</span>
							</a>
							<a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
								id="list-messages-list" data-toggle="list" href="#list-messages" role="tab"
								aria-controls="messages">
								attacker
								<span class="badge rounded-pill"
									style="background-color:yellow; color: black;">SFTP</span>
							</a>
							<a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
								id="list-settings-list" data-toggle="list" href="#list-settings" role="tab"
								aria-controls="settings">
								localhost
								<span class="badge rounded-pill"
									style="background-color:darkgreen; color:white;">VNC</span>
							</a>
							<a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
								id="list-settings-list" data-toggle="list" href="#list-settings" role="tab"
								aria-controls="settings">
								test@raspberrypi
								<span class="badge rounded-pill"
									style="background-color:springgreen; color:black;">Telnet</span>
							</a>
							<a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
								id="list-settings-list" data-toggle="list" href="#list-settings" role="tab"
								aria-controls="settings">
								Windows95
								<span class="badge rounded-pill"
									style="background-color: rgb(0, 164, 239); color: white;">RDP</span>
							</a>
							<a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
								id="list-settings-list" data-toggle="list" href="#list-settings" role="tab"
								aria-controls="settings">
								Ubuntu 20.04
								<span class="badge rounded-pill"
									style="background-color:orangered; color:white">WSL</span>
							</a>
						</div>


					</div>
				</div>
			</div>
		</div>

		-->



	<div id="left-panel" class="split" style="background-color: rgb(230, 230, 230);">
		<div id="bookmarks-container" class="container">
			<a id="btn_newSession" class="btn btn-primary" role="button">
				New session
			</a>


			<div class="accordion" id="accordionExample">
				<div class="accordion-item">
					<h2 class="accordion-header" id="headingOne">
						<button class="accordion-button" type="button" data-bs-toggle="collapse"
							data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
							Bookmarks
						</button>
					</h2>
					<div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne"
						data-bs-parent="#accordionExample">
						<div class="accordion-body" id="ToPopulate" style="padding: 0px;">
							<div class="list-group" id="SessionsContainer" role="tablist">
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div id="main-panel" class="split">
		<div class="chrome-tabs">
			<div class="chrome-tabs-content"></div>
			<div class="chrome-tabs-bottom-bar">
			</div>
		</div>

		<div id="tabs-content">
			<!-- Populated with hidden content and 1 visible content -->
		</div>

		<script>

			var el = document.querySelector('.chrome-tabs');
			const tabs_content = document.getElementById("tabs-content");
			var tabId = 0; // Last id. When new tab, ++. 
			var selectedTabId = null
			var tabs = []

			var chromeTabs = new ChromeTabs();
			chromeTabs.init(el);

			el.addEventListener('activeTabChange', ({ detail }) => {
				console.log('Active tab changed', detail.tabEl.id)

				// Hide previous content
				if (selectedTabId) {
					for (var tab of tabs) {
						if (tab["id"] == selectedTabId) {
							console.log("Hiding: ", selectedTabId)
							tab["DOM_content"].style = "display: none;"
							break
						}
					}
				}

				//Show new content
				selectedTabId = detail.tabEl.id
				for (var tab of tabs) {
					if (tab["id"] == selectedTabId) {
						console.log("Showing: ", selectedTabId)
						tab["DOM_content"].style = "display: block;"
						break
					}
				}
			})

			el.addEventListener('tabAdd', ({ detail }) => {
				detail.tabEl.id = "tabEl_" + tabId;
				console.log('Tab added', detail.tabEl.id)

				const content = document.createElement("div");
				content.setAttribute("id", "content_" + tabId);
				content.textContent = "Content with tabId " + tabId
				tabs_content.appendChild(content);

				tabs.push({
					"id": detail.tabEl.id,
					"DOM_tab": detail.tabEl,
					"DOM_content": content
				})

				tabId++;
			})
			el.addEventListener('tabRemove', ({ detail }) => {
				console.log('Tab removed', detail.tabEl.id)

				for (var i in tabs) {
					var t = tabs[i]
					if (t["id"] == detail.tabEl.id) {
						console.log("Removing from array: ", t)
						tabs.splice(i, 1)

						console.log("Removing content: ", t["DOM_content"])
						t["DOM_content"].remove()
						break
					}
				}
			})

			function addTerminalTab() {
				chromeTabs.addTab({
					title: 'Terminal',
					favicon: '../resources/terminal.png'
				});

				//Get the added tab
				var addedTabId = tabId - 1;
				for (var t of tabs) {
					if (t["id"] == "tabEl_" + addedTabId) {
						console.log("Last tab added is ", t)

						var terminal = document.createElement("div")
						terminal.id = "terminal"
						t["DOM_content"].appendChild(terminal)
						t["buffer"] = ""

						var term = new Terminal({
							cursorBlink: "block"
						});
						term.open(terminal) //Create terminal UI




						term.onKey((event) => {
							var buffer = t["buffer"]
							var key = event.key
							var keyCode = key.charCodeAt(0)

							console.log("onKey: ", event)
							console.log("Key: ", key, "Key code: ", keyCode)

							//Enter
							if (key.charCodeAt(0) == 13) {
								//TODO: Send ssh2 a command!
								//term.write('\n');
								var command 
								buffer = ""
							}
							//Backspace (delete)
							else if (key.charCodeAt(0) == 127) {
								//term.write('\x1b[D')
								if (buffer.length > 0) {
									//Do not delete prompt
									term.write("\b \b")
									buffer = buffer.substring(0, buffer.length - 1)
								}
							} else if (keyCode < 32 || keyCode > 127) {
								//Do not insert special characters such as Shift+Backspace, Ctrl, Alt
								console.log("Not printable character!")
								return
							} else {
								//TODO: Enable pressing 'Home' and 'End' to go back and fourth
								
								term.write(key);
								buffer += "" + key;
							}

							console.log("Buffer: ", buffer)
							t["buffer"] = buffer
						});


						term.onData((str) => {
							console.log("onData: ", str)
						});

						term.onLineFeed((number) => {
							console.log("onLineFeed: ", number)
						});

						term.onSelectionChange(() => {
							console.log("onSelectionChange")
							console.log("Selection: ", term.getSelection())
						});

						term.onBinary((string) => {
							console.log("onBinary: ", string)
						});

						//Give it a callback that is called on each line of output of socket in ssh
						window.api.startSSH((data) => {
							term.write(data)
						});
						break
					}
				}


			}

			addTerminalTab();
			//addTerminalTab();
			//addTerminalTab();
		</script>
	</div>

	<script type="module">
		import Split from '../third-party/split/packages/splitjs/src/split.js';
		Split(['#left-panel', '#main-panel'],
			{
				sizes: [20, 80],
				gutterSize: 5,

			}
		);
	</script>


	<script>
		//window.api.loadscript("../js/index.js");
	</script>

</body>

</html>